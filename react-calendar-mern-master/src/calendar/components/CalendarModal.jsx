import { useState, useMemo, useEffect } from 'react';
import { addHours } from 'date-fns';
import Modal from 'react-modal';
import DatePicker, { registerLocale } from 'react-datepicker';
import 'react-datepicker/dist/react-datepicker.css';
import ko from 'date-fns/locale/ko';
import Swal from 'sweetalert2';
import 'sweetalert2/dist/sweetalert2.min.css';
import { useCalendarStore, useUiStore } from '../../hooks';
import './CalendarModal.css';

registerLocale('ko', ko);
Modal.setAppElement('#root');

const initialFormState = {
    title: '',
    notes: '',
    location: '',
    start: new Date(),
    end: addHours(new Date(), 2),
    isAllDay: false,
    calendar: '',
    attachments: [] //ÌååÏùº Î∞∞Ïó¥
};

export const CalendarModal = () => {
    const { isDateModalOpen, closeDateModal } = useUiStore();
    const { activeEvent, startSavingEvent, startDeletingEvent, calendars } = useCalendarStore(); 
    
    const [formValues, setFormValues] = useState(initialFormState);

    useEffect(() => {
        if (activeEvent) {
            // activeEvent.calendarÍ∞Ä Í∞ùÏ≤¥Ïùº Ïàò ÏûàÏúºÎØÄÎ°ú IDÎ•º Ï∂îÏ∂ú
            const selectedCalendarId =
            typeof activeEvent.calendar === 'string'
                ? activeEvent.calendar
                : activeEvent.calendar?.id || activeEvent.calendar?._id || '';

            setFormValues({
            ...initialFormState,
            ...activeEvent,
            calendar: selectedCalendarId,    // Î¨∏ÏûêÏó¥ IDÎ°ú Ï†ÄÏû•
            });
        } else {
            const defaultCalendarId = calendars.length > 0 ? calendars[0].id : '';
            setFormValues({ ...initialFormState, calendar: defaultCalendarId });
        }
    }, [activeEvent, isDateModalOpen, calendars]);

    const onInputChange = ({ target }) => {
        setFormValues({ ...formValues, [target.name]: target.value });
    };

    const onDateChange = (event, changing) => {
        setFormValues({ ...formValues, [changing]: event });
    };

    const onCloseModal = () => {
        closeDateModal();
    };


     
    const onSubmit = async (e) => {
        e.preventDefault();

        const data = {
            ...formValues,
            start: new Date(formValues.start).toISOString(),
            end: new Date(formValues.end).toISOString(),
        };

        console.log('üì§ Ï†ÄÏû• ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞:', data);

        try {
            await startSavingEvent(data); // axios.post('/api/events', data)
            closeDateModal();
        } catch (error) {
            console.error('‚ùå Ïù¥Î≤§Ìä∏ Ï†ÄÏû• Ïã§Ìå®:', error);
        }
    };


    const handleDeleteEvent = () => {
        startDeletingEvent();
        closeDateModal();
    }
    

    return (
        <Modal
            isOpen={isDateModalOpen}
            onRequestClose={onCloseModal}
            className="modal"
            overlayClassName="modal-fondo"
            closeTimeoutMS={200}
        >
            <div className="modal-container">
                <form className="form-container" onSubmit={onSubmit}>
                    
                    <div className="form-group">
                        <label>Ï†úÎ™©</label>
                        <input
                            type="text"
                            className="form-control"
                            placeholder="ÏùºÏ†ï Ï†úÎ™©"
                            name="title"
                            autoComplete="off"
                            value={formValues.title || ''}
                            onChange={onInputChange}
                        />
                    </div>

                    <div className="form-group">
                        <label>Ïû•ÏÜå</label>
                        <div className="input-with-button">
                            <input
                                type="text"
                                className="form-control"
                                placeholder="Ïû•ÏÜå"
                                name="location"
                                value={formValues.location || ''}
                                onChange={onInputChange}
                            />
                            <button type="button" className="btn-secondary">ÏßÄÎèÑÏ≤®Î∂Ä</button>
                        </div>
                    </div>

                    <div className="form-group">
                        <label>ÏùºÏãú</label>
                        <div className="date-picker-group">
                            <DatePicker
                                selected={formValues.start}
                                onChange={(event) => onDateChange(event, 'start')}
                                className="form-control"
                                dateFormat="yyyy.MM.dd aa h:mm"
                                showTimeSelect
                                locale="ko"
                            />
                            <span className="date-separator">-</span>
                            <DatePicker
                                minDate={formValues.start}
                                selected={formValues.end}
                                onChange={(event) => onDateChange(event, 'end')}
                                className="form-control"
                                dateFormat="yyyy.MM.dd aa h:mm"
                                showTimeSelect
                                locale="ko"
                            />
                            <div className="checkbox-group">
                                <input type="checkbox" id="all-day" name="isAllDay" checked={formValues.isAllDay} onChange={onInputChange} />
                                <label htmlFor="all-day">Ï¢ÖÏùº</label>
                            </div>
                        </div>
                    </div>
                    
                    <div className="form-group">
                        <label>Ï∞∏ÏÑùÏûê</label>
                        <div className="input-with-button">
                            <input type="text" className="form-control" placeholder="Ïù¥Î¶Ñ ÎòêÎäî Ïù¥Î©îÏùº Ï£ºÏÜå, ÏïÑÏù¥ÎîîÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî." />
                            <button type="button" className="btn-secondary">ÎÑ§Ïù¥Î≤Ñ Ï£ºÏÜåÎ°ù</button>
                        </div>
                    </div>

                    <div className="form-group inline-group">
                        <label>Í≥µÍ∞ú</label>
                        <input type="radio" id="public" name="visibility" value="public" defaultChecked />
                        <label htmlFor="public">Í∏∞Î≥∏</label>
                        <input type="radio" id="private" name="visibility" value="private" />
                        <label htmlFor="private">ÎπÑÍ≥µÍ∞ú</label>
                    </div>
                    
                    <div className="form-group">
                        <label>Ï∫òÎ¶∞Îçî</label>
                        <select 
                            name="calendar" 
                            className="form-control" 
                            //value={formValues.calendar || ''}
                            value={formValues.calendar} 
                            onChange={onInputChange}
                        >
                            {
                                calendars.map( cal => (
                                    <option key={cal.id} value={cal.id}>
                                        {cal.name}
                                    </option>
                                ))
                            }
                        </select>
                    </div>

                    <div className="form-group">
                        <label>ÏÑ§Î™Ö</label>
                        <textarea
                            type="text"
                            className="form-control"
                            placeholder="ÏùºÏ†ïÏóê ÌïÑÏöîÌïú ÏÑ§Î™ÖÏùÑ ÎÇ®Í∏∞ÏÑ∏Ïöî."
                            rows="3"
                            name="notes"
                            value={formValues.notes || ''}
                            onChange={onInputChange}
                        ></textarea>
                    </div>

                    <div className="form-group">
                        <label>ÌååÏùº Ï≤®Î∂Ä</label>
                        <input
                            type="file"
                            className="form-control"
                            name="attachments"
                            multiple 
                            accept=".pdf,image/*"
                            onChange={(e) =>
                            setFormValues({
                                ...formValues,
                                attachments: Array.from(e.target.files),  // ÌååÏùº Î∞∞Ïó¥ Ï†ÄÏû•
                            })
                            }
                        />
                    </div>

                    <div className="form-group">
                         <label>ÏïåÎ¶º</label>
                         <div className="notification-group">
                            <select className="form-control">
                                <option>10Î∂Ñ Ï†Ñ</option>
                                <option>30Î∂Ñ Ï†Ñ</option>
                                <option>1ÏãúÍ∞Ñ Ï†Ñ</option>
                            </select>
                            <button type="button" className="btn-secondary">ÏïåÎ¶ºÏ∂îÍ∞Ä</button>
                         </div>
                    </div>

                    <hr/>
                    
                    <div className="form-actions">
                        { activeEvent && (
                          <button
                            type="button"
                            className="btn btn-danger"
                            onClick={handleDeleteEvent}
                          >
                            <i className="fas fa-trash"></i>
                            <span> ÏÇ≠Ï†ú</span>
                          </button>
                        )}
                        <button type="submit" className="btn btn-primary">
                          <i className="far fa-save"></i>
                          <span> Ï†ÄÏû•</span>
                        </button>
                        <button type="button" className="btn btn-secondary" onClick={onCloseModal}>
                          <span>Ï∑®ÏÜå</span>
                        </button>
                    </div>

                </form>
            </div>
        </Modal>
    );
};
